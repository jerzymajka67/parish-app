<body>
   <main>
<div class="container-fluid mt-4 events-page">
  <div class="row">
    <!-- LEFT: INTRO TEXT -->
    <div class="col-md-7 p-5 intro-column">
      <div id="gallery" class="row g-3 mt-4"></div>
      <h2 class="mb-4">Parish Events Gallery</h2>
      <p class="lead">
        On this page you will find photos from various parish events
        and interesting places within our parish community.
      </p>
      <p>
        This page is still under construction, so for now we invite you
        to browse photos of
        <a href="#"
          onclick="loadGallery('2026/01. January/Photos of our churches/OLQA'); return false;">
          our parish churches
        </a>
        as well as photos of the
        <a href="#"
          onclick="loadGallery('2025/12. December/Schonstatt Movement in Our Parish'); return false;">
          Schoenstatt Movement in our parish
        </a>.
      </p>
      <p>
        We hope that, with your help, this gallery will soon begin to fill
        with meaningful and beautiful photos that reflect the life
        and faith of our parish community.
      </p>
      <p class="signature">
        â€” Your Parish Community
      </p>
    </div>
    <!-- RIGHT: BROWSER -->
    <div class="col-md-5 border-start p-4 browser-column">
      <h5 class="mb-3">Parish Photo Gallery</h5>
      <div id="browser-container">
        <div id="browser" class="list-group"></div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div id="modalContent" class="modal-content bg-dark">
      <button type="button" class="btn-close btn-close-white"
              data-bs-dismiss="modal"></button>

      <div class="modal-body text-center position-relative p-0">
<button class="btn btn-dark position-absolute top-50 start-0 translate-middle-y fs-1 px-4 nav-arrow"
        onclick="Viewer.prev()">â€¹</button>

<img id="modalImage" class="img-fluid">

<button class="btn btn-dark position-absolute top-50 end-0 translate-middle-y fs-1 px-4 nav-arrow"
        onclick="Viewer.next()">â€º</button>

      </div>
    </div>
  </div>
</div>

</main>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const browser = document.getElementById('browser');
  function render(tree, basePath, container) {
    for (const name in tree) {
      if (name === 'files') continue;
      if (name === 'thumbs') continue;
      const fullPath = basePath
        ? basePath + '/' + name
        : name;
      const folder = document.createElement('a');
      folder.href = '#';
      folder.className =
        'list-group-item list-group-item-action fw-bold';
      folder.textContent = 'ðŸ“ ' + name;
      const collapse = document.createElement('div');
      collapse.className = 'collapse ps-3';
      const bs = new bootstrap.Collapse(
        collapse,
        { toggle: false }
      );
      folder.onclick = async e => {
        e.preventDefault();
        e.stopPropagation();
        const isGallery = await loadGallery(fullPath);
        // If gallery â†’ do not expand tree
        if (isGallery) {
          bs.hide();
          return;
        }

        // Otherwise load subfolders
        if (!collapse.hasChildNodes()) {
          load(fullPath, collapse);
        }

        bs.toggle();
      };

      container.append(folder, collapse);
    }
  }

  function load(path, container) {
    fetch('/en/events/ls?path=' + encodeURIComponent(path))
      .then(r => r.json())
      .then(data => render(data, path, container))
      .catch(err => console.error(err));
  }

  /* =========================
     INITIAL LOAD
  ========================== */

  fetch('/en/events/ls')
    .then(r => r.json())
    .then(data => render(data, '', browser))
    .catch(err => console.error(err));
// viewer.js
(function () {

  let gallery = [];
  let index = 0;

  let isMagnifierActive = false;
  let isDragging = false;
  let dragMoved = false;

  let startX = 0;
  let startY = 0;
  let translateX = 0;
  let translateY = 0;

  function getModal() {
    return document.getElementById("imageModal");
  }

  function getImage() {
    return document.getElementById("modalImage");
  }

  function getModalContent() {
    return document.getElementById("modalContent");
  }

  function showModal() {
    const modalEl = getModal();
    const instance = new bootstrap.Modal(modalEl);
    instance.show();
  }

  function hideModal() {
    const modalEl = getModal();
    const instance = bootstrap.Modal.getInstance(modalEl);
    if (instance) instance.hide();
  }

  function showImage() {
    const img = getImage();
    if (!img || !gallery.length) return;

    exitZoom();   // important: reset zoom when changing photo
    img.src = gallery[index];
  }

  function enterZoom() {
    const img = getImage();
    const modalContent = getModalContent();

    isMagnifierActive = true;

    document.body.classList.add("zoom-active");
    modalContent.classList.add("zoom-mode");
    img.classList.add("zoom-fullscreen");

    img.style.transform = "translate(0px, 0px) scale(2)";
  }

  function exitZoom() {
    const img = getImage();
    const modalContent = getModalContent();

    isMagnifierActive = false;
    isDragging = false;
    dragMoved = false;
    translateX = 0;
    translateY = 0;

    document.body.classList.remove("zoom-active");
    modalContent.classList.remove("zoom-mode");
    img.classList.remove("zoom-fullscreen");

    img.style.transform = "scale(1)";
  }

  window.Viewer = {

    setGallery(arr) {
      gallery = arr || [];
    },

    open(i = 0) {
      index = i;
      showImage();
      showModal();
    },

    close() {
      exitZoom();
      hideModal();
    },

    next() {
      if (!gallery.length) return;
      index = (index + 1) % gallery.length;
      showImage();
    },

    prev() {
      if (!gallery.length) return;
      index = (index - 1 + gallery.length) % gallery.length;
      showImage();
    }
  };

  document.addEventListener("DOMContentLoaded", function () {

    const img = getImage();
    const modalContent = getModalContent();

    if (!img || !modalContent) return;

    img.setAttribute("draggable", "false");
    img.addEventListener("dragstart", e => e.preventDefault());

    /* ======================================================
       DESKTOP BEHAVIOR (NO TOUCH SUPPORT)
    ====================================================== */

    if (!('ontouchstart' in window)) {

      /* CLICK TO TOGGLE ZOOM */
      img.addEventListener("click", function () {

        if (!isMagnifierActive) {
          enterZoom();
        } else if (!dragMoved) {
          exitZoom();
        }

        dragMoved = false;
      });

      /* DRAG START */
      img.addEventListener("mousedown", function (e) {
        if (!isMagnifierActive) return;

        e.preventDefault();

        isDragging = true;
        dragMoved = false;

        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
      });

      /* DRAG MOVE */
      document.addEventListener("mousemove", function (e) {
        if (!isDragging || !isMagnifierActive) return;

        dragMoved = true;

        translateX = e.clientX - startX;
        translateY = e.clientY - startY;

        img.style.transform =
          `translate(${translateX}px, ${translateY}px) scale(2)`;
      });

      /* DRAG END */
      document.addEventListener("mouseup", function () {
        isDragging = false;
      });

    }

    /* ======================================================
       MOBILE TOUCH BEHAVIOR
    ====================================================== */

    if ('ontouchstart' in window) {

      let touchStartX = 0;
      let initialDistance = 0;
      let scale = 1;
      let isZooming = false;

      /* SWIPE */
      img.addEventListener("touchstart", e => {

        if (e.touches.length === 1) {
          touchStartX = e.touches[0].clientX;
        }

        if (e.touches.length === 2) {
          isZooming = true;
        }

      });

      img.addEventListener("touchend", e => {

        if (isZooming) {
          isZooming = false;
          return;
        }

        const touchEndX = e.changedTouches[0].clientX;
        const diff = touchStartX - touchEndX;

        if (Math.abs(diff) > 60) {

          if (diff > 0) {
            Viewer.next();
          } else {
            Viewer.prev();
          }

        }

      });

      /* PINCH ZOOM */
      img.addEventListener("touchmove", e => {

        if (e.touches.length === 2) {

          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;

          const distance = Math.sqrt(dx * dx + dy * dy);

          if (!initialDistance) {
            initialDistance = distance;
          } else {

            scale = distance / initialDistance;
            scale = Math.min(Math.max(scale, 1), 4);

            img.style.transform = `scale(${scale})`;
          }

          e.preventDefault();
        }

      });

      img.addEventListener("touchend", () => {
        initialDistance = 0;
      });

    }

    /* ESC CLOSES MODAL */
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") {
        Viewer.close();
      }
    });

  });

})();

    
});
</script>
</body>
