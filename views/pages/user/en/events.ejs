<body>
   <main>
<div class="container-fluid mt-4 events-page">
  <div class="row">
    <!-- LEFT: INTRO TEXT -->
    <div class="col-md-7 p-5 intro-column">
      <div id="gallery" class="row g-3 mt-4"></div>
      <h2 class="mb-4">Parish Events Gallery</h2>
      <p class="lead">
        On this page you will find photos from various parish events
        and interesting places within our parish community.
      </p>
      <p>
        This page is still under construction, so for now we invite you
        to browse photos of
        <a href="/content/events/2026/01.%20January/Photos%20of%20our%20churches">
          our parish churches
        </a>
        as well as photos of the
        <a href="/content/events/2025/12.%20December/Schonstatt%20Movement%20in%20Our%20Parish">
          Schoenstatt Movement in our parish
        </a>.
      </p>
      <p>
        We hope that, with your help, this gallery will soon begin to fill
        with meaningful and beautiful photos that reflect the life
        and faith of our parish community.
      </p>
      <p class="signature">
        â€” Your Parish Community
      </p>
    </div>
    <!-- RIGHT: BROWSER -->
    <div class="col-md-5 border-start p-4 browser-column">
      <h5 class="mb-3">Parish Photo Gallery</h5>
      <div id="browser-container">
        <div id="browser" class="list-group"></div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="imageModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark">
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"aria-label="Close"></button>
      <div class="modal-body text-center position-relative p-0">
          <button class="btn btn-dark position-absolute top-50 start-0 translate-middle-y fs-1 px-4"
          onclick="prevImage()">â€¹</button>
            <img id="modalImage" class="img-fluid">
        <button class="btn btn-dark position-absolute top-50 end-0 translate-middle-y fs-1 px-4"
          onclick="nextImage()">â€º</button>
      </div>
    </div>
  </div>
</div>

</main>
<script>
let currentGallery = [];
let currentIndex = 0;
function openAdminViewer(filePath) {
  currentFile = filePath;
  currentRotation = 0;

  const img = document.getElementById('modalImage'); // â† updated ID

  const encodedPath = filePath
    .split('/')
    .map(encodeURIComponent)
    .join('/');

  img.onload = () => {
    const isVertical = img.naturalHeight > img.naturalWidth;

    if (isVertical) {
      img.style.height = '90vh';
      img.style.width = 'auto';
    } else {
      img.style.width = '80vw';
      img.style.height = 'auto';
    }
  };

  img.src = '/content/events/' + encodedPath;

  // âœ… Bootstrap modal show
  const modal = new bootstrap.Modal(
    document.getElementById('imageModal')
  );
  modal.show();
}

function closeViewer() {
  const img = document.getElementById('modalImage');

  // reset rotation
  img.style.transform = 'rotate(0deg)';

  // optional: clear source (safe)
  img.removeAttribute('src');

  currentFile = null;
  currentRotation = 0;

  // Bootstrap hide
  const modalEl = document.getElementById('imageModal');
  const modalInstance = bootstrap.Modal.getInstance(modalEl);

  if (modalInstance) {
    modalInstance.hide();
  }
}

function nextImage() {
    currentIndex = (currentIndex + 1) % currentGallery.length;
    showImage();
    }
function prevImage() {
    currentIndex =
      (currentIndex - 1 + currentGallery.length) % currentGallery.length;
    showImage();
    }
function showImage() {
  const img = document.getElementById('modalImage');
  img.src = currentGallery[currentIndex];
}
function openLightbox(index) {
  //onsole.log('Opening lightbox for index:', index, 'Gallery:', currentGallery);
  currentIndex = index;
  showImage();
  const modalElement = document.getElementById('imageModal');
  if (!modalElement) {
    console.error('imageModal not found in DOM');
    return;
  }

  let modalInstance = bootstrap.Modal.getInstance(modalElement);

  if (!modalInstance) {
    modalInstance = new bootstrap.Modal(modalElement);
  }

  modalInstance.show();
}
function renderGallery(folderPath, thumbs) {

  console.log('renderGallery called', folderPath, thumbs);

  currentGallery = thumbs.map(file =>
    `/content/events/${folderPath}/${file}`
  );

  const gallery = document.getElementById('gallery');
  gallery.innerHTML = '';

  thumbs.forEach((file, index) => {
    const img = document.createElement('img');
    img.src = `/content/events/${folderPath}/thumbs/${file}`;
    img.onclick = () => openLightbox(index);
    gallery.appendChild(img);
  });
}
async function loadGallery(folderPath) {

  const res = await fetch(
    '/en/events/thumbs?path=' + encodeURIComponent(folderPath)
  );
  const data = await res.json();

  if (!data.isGallery) {
    document.getElementById('gallery').innerHTML = '';
    return false;
  }

  renderGallery(folderPath, data.thumbs);
  return true;
}

document.addEventListener('DOMContentLoaded', () => {
  document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeViewer();
});
const img = document.getElementById('modalImage');

img.addEventListener('click', function () {
  console.log('Image clicked');
  img.classList.toggle('zoomed');
});

  const browser = document.getElementById('browser');
  function render(tree, basePath, container) {
    for (const name in tree) {
      if (name === 'files') continue;
       if (name === 'thumbs') continue; 
      const fullPath = basePath ? basePath + '/' + name : name;
      const folder = document.createElement('a');
      folder.href = '#';
      folder.className = 'list-group-item list-group-item-action fw-bold';
      folder.textContent = 'ðŸ“ ' + name;
      const collapse = document.createElement('div');
      collapse.className = 'collapse ps-3';
      const bs = new bootstrap.Collapse(collapse, { toggle: false });
        folder.onclick = async e => {
          e.preventDefault();
          e.stopPropagation();

          // 1ï¸âƒ£ Ask backend what this folder is
          const isGallery = await loadGallery(fullPath);

          // 2ï¸âƒ£ If it is a gallery â†’ DO NOT expand tree
          if (isGallery) {
            bs.hide();
            return;
          }

          // 3ï¸âƒ£ Normal folder behavior
          if (!collapse.hasChildNodes()) {
            load(fullPath, collapse);
          }

          bs.toggle();
        };
      container.append(folder, collapse);
    }
  }
  function load(path, container) {
    fetch('/en/events/ls?path=' + encodeURIComponent(path))
      .then(r => r.json())
      .then(data => render(data, path, container))
      .catch(err => console.error(err));
  }
  // initial load (root)
  fetch('/en/events/ls')
    .then(r => r.json())
    .then(data => render(data, '', browser))
    .catch(err => console.error(err));

});
</script>
</body>
