<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Folder Tree</title>

<!-- Bootstrap CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<style>

/* ===============================
   Global & Fonts
   =============================== */

/* Import a fancy Google font for the heading */
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap');

body {
  font-family: Arial, sans-serif; /* default body font */
  margin: 0;
  padding: 0;
  background-color: #f8f9fa;
}

/* ===============================
   Heading
   =============================== */
h2 {
  font-family: 'Playfair Display', serif; /* fancy but readable */
  text-align: center;
  margin: 15px 0;
  color: #3c763d; /* smooth greenish color */
  font-size: 2rem;
}

/* ===============================
   Folder Tree Container
   =============================== */
#browser-container {
  margin: 15px 200px 15px 30px; /* top, right, bottom, left */
  padding: 10px;
  background-color: #ffffff;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  max-height: 70vh;   /* limit height to allow scrolling */
  overflow-y: auto;   /* vertical scroll if content is too long */
}

/* Optional: scroll bar styling */
#browser-container::-webkit-scrollbar {
  width: 8px;
}

#browser-container::-webkit-scrollbar-thumb {
  background-color: #adb5bd;
  border-radius: 4px;
}

#browser-container::-webkit-scrollbar-track {
  background: #f1f1f1;
}

/* ===============================
   Forms styling
   =============================== */
form {
  margin: 10px 0;
}

input[type="text"] {
  padding: 6px 10px;
  font-size: 1rem;
  border-radius: 4px;
  border: 1px solid #ced4da;
}

button.btn-action {
  padding: 6px 12px;
  font-size: 1rem;
  border-radius: 4px;
}

/* Optional: hover effect for buttons */
button.btn-action:hover {
  opacity: 0.9;
}


</style>
</head>
<body>
<h2>Admin Folder Tree</h2>

<!-- Create folder form -->
<form id="createFolderForm" action="/admin/about/create-folder" method="POST" class="mb-3 d-flex gap-2 align-items-center">
  <input type="hidden" name="currentPath">

  <button type="submit" class="btn btn-primary">Create Folder</button>

  <input id="root-folder" type="text" value="In: " readonly class="form-control" style="max-width: 400px;">
  <input id="new-folder" type="text" name="folderName" placeholder="New folder name" required class="form-control" style="max-width: 300px;">
</form>

<!-- Delete folder form -->
<form id="deleteSelectedForm" action="/admin/about/delete-selected" method="POST" class="mb-3">
  <input type="hidden" name="currentPath">

  <div class="d-flex gap-2 align-items-center">
    <button type="submit" class="btn btn-danger" id="deleteBtn">Delete Folder</button>
    <input id="delete-folder-name" type="text" readonly class="form-control" style="max-width: 420px;" placeholder="No folder selected">
  </div>
</form>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete <strong id="modal-folder-name"></strong>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div>

<div id="info" class="mb-2 fw-bold"></div>
<div id="browser-container">
  <div id="browser" class="list-group"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const browser = document.getElementById('browser');
  const info = document.getElementById('info');

  const rootInfo = document.getElementById('root-folder');
  const createFolderForm = document.getElementById('createFolderForm');
  const deleteSelectedForm = document.getElementById('deleteSelectedForm');
  const createPathInput = createFolderForm.querySelector('input[name="currentPath"]');
  const deletePathInput = deleteSelectedForm.querySelector('input[name="currentPath"]');
  const deleteFolderName = document.getElementById('delete-folder-name');
  const deleteBtn = document.getElementById('deleteBtn');

  const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
  const modalFolderName = document.getElementById('modal-folder-name');
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

  let selectedItem = null;
  let selectedPath = null;

  function selectItem(el, path) {
    if (selectedItem) selectedItem.classList.remove('active');
    selectedItem = el;
    selectedPath = path;
    if (selectedItem) selectedItem.classList.add('active');
    setCurrentFolder(path);
  }

  function setCurrentFolder(path) {
    createPathInput.value = path;
    deletePathInput.value = path;
    rootInfo.value = `In: ${path || '/'}`;
    const parts = path.split('/').filter(Boolean);
    deleteFolderName.value = parts.at(-1) || '';

    // disable delete for root
    deleteBtn.disabled = !path;
  }

  function renderTree(tree, parentPath, container) {
    for (const name in tree) {
      if (name === 'files') continue;
      const fullPath = parentPath ? parentPath + '/' + name : name;
      const collapseId = 'folder-' + encodeURIComponent(fullPath);

      // folder item
      const folderItem = document.createElement('a');
      folderItem.href = '#';
      folderItem.className = 'list-group-item list-group-item-action';
      folderItem.textContent = name;

      // collapse container
      const collapseDiv = document.createElement('div');
      collapseDiv.className = 'collapse ps-3';
      collapseDiv.id = collapseId;

      const bsCollapse = new bootstrap.Collapse(collapseDiv, { toggle: false });

      folderItem.addEventListener('click', e => {
        e.preventDefault();
        e.stopPropagation();
        selectItem(folderItem, fullPath);
        if (!collapseDiv.hasChildNodes()) getServerTree(fullPath, collapseDiv);
        bsCollapse.toggle();
      });

      container.appendChild(folderItem);
      container.appendChild(collapseDiv);
    }

    // files with checkbox
    if (tree.files) {
      tree.files.forEach(file => {
        const filePath = parentPath ? parentPath + '/' + file : file;

        const fileDiv = document.createElement('div');
        fileDiv.className = 'list-group-item d-flex align-items-center';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'form-check-input me-2';
        checkbox.value = filePath;

        const label = document.createElement('span');
        label.textContent = file;

        fileDiv.appendChild(checkbox);
        fileDiv.appendChild(label);

        fileDiv.addEventListener('click', e => {
          e.stopPropagation();
          selectItem(fileDiv, filePath);
        });

        container.appendChild(fileDiv);
      });
    }
  }

  function getServerTree(path, containerDiv) {
    fetch('/admin/about/ls?path=' + encodeURIComponent(path))
      .then(res => res.ok ? res.json() : Promise.reject('HTTP ' + res.status))
      .then(data => renderTree(data, path, containerDiv))
      .catch(err => info.textContent = 'Error: ' + err);
  }

  // initial load
  fetch('/admin/about/ls')
    .then(res => res.ok ? res.json() : Promise.reject('HTTP ' + res.status))
    .then(data => renderTree(data, '', browser))
    .catch(err => info.textContent = 'Error: ' + err);

  // delete with confirmation modal
  deleteSelectedForm.addEventListener('submit', e => {
    e.preventDefault();
    if (!deletePathInput.value) return;
    modalFolderName.textContent = deleteFolderName.value;
    modal.show();
  });

  confirmDeleteBtn.addEventListener('click', () => {
    deleteSelectedForm.submit(); // normal POST, server refreshes tree
    modal.hide();
  });
});
</script>

</body>
</html>
