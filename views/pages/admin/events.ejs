<body>

<h2><%= title %></h2>

<!-- CREATE FOLDER -->
<form id="createFolderForm"
      action="/admin/events/create-folder"
      method="POST"
      class="mb-2 d-flex gap-2 align-items-center">

  <input type="hidden" name="currentPath">

  <button type="submit" class="btn btn-primary">Create Folder</button>

  <input id="root-folder"
         type="text"
         readonly
         class="form-control"
         style="max-width:420px">

  <input type="text"
         name="folderName"
         placeholder="New folder name"
         required
         class="form-control"
         style="max-width:300px">
</form>

<!-- UPLOAD IMAGES -->
<form id="uploadImageForm"
      action="/admin/events/upload-image"
      method="POST"
      enctype="multipart/form-data"
      class="mb-3 d-flex gap-2 align-items-center">

  <input type="hidden" name="currentPath">

  <button type="submit"
          class="btn btn-success"
          id="uploadBtn"
          disabled>
    Upload Images
  </button>

  <input type="file"
         name="images"
         accept="image/*"
         multiple
         required
         class="form-control"
         style="max-width:420px">
</form>


<!-- DELETE (FILES OR FOLDER) -->
<form id="deleteSelectedForm"
      class="mb-3 d-flex gap-2 align-items-center">

  <input type="hidden" name="currentPath">

  <button type="submit"
          class="btn btn-danger"
          id="deleteBtn"
          disabled>
    Delete
  </button>

  <input id="delete-folder-name"
         type="text"
         readonly
         class="form-control"
         style="max-width:420px"
         placeholder="Nothing selected">
</form>

<!-- CONFIRM DELETE MODAL -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Confirm delete</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        Delete <strong id="modal-folder-name"></strong>?
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>

    </div>
  </div>
</div>

<!-- BROWSER -->
<div id="browser-container">
  <div id="browser" class="list-group"></div>
</div>
<div id="photoViewer" class="modal hidden">
  <div class="viewer-body">
    <img id="viewerImage" />

    <div class="viewer-controls">
      <button onclick="rotatePreview(-90)">âŸ²</button>
      <button onclick="rotatePreview(90)">âŸ³</button>
      <button onclick="saveRotation()">ðŸ’¾ Save</button>
      <button onclick="closeViewer()">âœ–</button>
    </div>
  </div>
</div>

<script>
// ===============================
// Admin Photo Viewer â€“ Rotation
// ===============================

// current file relative to content/events
let currentFile = null;

// current preview rotation (degrees)
let currentRotation = 0;

// -------------------------------
// Open admin viewer
// -------------------------------
function openAdminViewer(filePath) {
  console.log('Opening viewer for', filePath);

  currentFile = filePath;
  currentRotation = 0;

  const img = document.getElementById('viewerImage');

  // reset preview rotation
  img.style.transform = 'rotate(0deg)';

  // encode path SAFELY (keep slashes!)
const encodedPath = filePath
  .split('/')
  .map(encodeURIComponent)
  .join('/');

img.onload = () => {
  console.log('Image loaded:', img.naturalWidth, img.naturalHeight);
};

img.onerror = () => {
  console.error('Image failed to load:', img.src);
};

img.src = '/content/events/' + encodedPath;


  // show viewer
  document.getElementById('photoViewer').classList.remove('hidden');
}
// -------------------------------
// Rotate preview ONLY (CSS)
// -------------------------------
function rotatePreview(delta) {
  currentRotation = (currentRotation + delta) % 360;
  if (currentRotation < 0) currentRotation += 360;

  document.getElementById('viewerImage').style.transform =
    `rotate(${currentRotation}deg)`;
}
// -------------------------------
// Save rotation (PERMANENT)
// -------------------------------
async function saveRotation() {
  if (!currentFile || currentRotation === 0) {
    return; // nothing to do
  }
  try {
    const res = await fetch('/admin/events/rotation', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        file: currentFile,   // relative to content/events
        angle: currentRotation
      })
    });
    const resThumb = await fetch('/admin/events/rotation-thumbs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        file: currentFile,   // relative to content/events
        angle: currentRotation
      })
    });
    if (!res.ok) {
      console.error('Rotation failed');
      return;
    }
    currentRotation = 0;
    document.getElementById('viewerImage').style.transform = 'rotate(0deg)';
  } catch (err) {
    console.error('Rotation error:', err);
  }
}

// -------------------------------
// Close viewer (discard preview)
// -------------------------------
function closeViewer() {
  const img = document.getElementById('viewerImage');

  img.style.transform = 'rotate(0deg)';

  currentFile = null;
  currentRotation = 0;

  document.getElementById('photoViewer').classList.add('hidden');
}

document.addEventListener('DOMContentLoaded', () => {

  const browser = document.getElementById('browser');

  const createPath = document.querySelector('#createFolderForm input[name="currentPath"]');
  const uploadPath = document.querySelector('#uploadImageForm input[name="currentPath"]');
  const deletePath = document.querySelector('#deleteSelectedForm input[name="currentPath"]');

  const rootInfo  = document.getElementById('root-folder');
  const deleteName = document.getElementById('delete-folder-name');
  const deleteBtn  = document.getElementById('deleteBtn');
  const uploadBtn  = document.getElementById('uploadBtn');

  const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
  const modalName = document.getElementById('modal-folder-name');
  const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

  let selectedItem = null;

  function getSelectedFiles() {
    return [...document.querySelectorAll('input[name="files[]"]:checked')]
      .map(cb => cb.value);
  }

  function setCurrent(path) {
    createPath.value = uploadPath.value = deletePath.value = path;
    rootInfo.value = 'In: ' + (path || '/');
    deleteName.value = path.split('/').pop() || '';
    deleteBtn.disabled = uploadBtn.disabled = !path;
  }

  function select(el, path) {
    selectedItem?.classList.remove('active');
    selectedItem = el;
    el.classList.add('active');
    setCurrent(path);
  }

  function render(tree, basePath, container) {

    for (const name in tree) {
      if (name === 'files') continue;

      const fullPath = basePath ? basePath + '/' + name : name;

      const folder = document.createElement('a');
      folder.href = '#';
      folder.className = 'list-group-item list-group-item-action';
      folder.textContent = name;

      const collapse = document.createElement('div');
      collapse.className = 'collapse ps-3';

      const bs = new bootstrap.Collapse(collapse, { toggle:false });

      folder.onclick = e => {
        e.preventDefault();
        e.stopPropagation();
        select(folder, fullPath);
        if (!collapse.hasChildNodes()) load(fullPath, collapse);
        bs.toggle();
      };

      container.append(folder, collapse);
    }

   (tree.files || []).forEach(file => {
        const filePath = basePath ? basePath + '/' + file : file;
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex align-items-center gap-2';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.name = 'files[]';
        cb.value = filePath;
        const link = document.createElement('a');
        link.href = '#';
        link.textContent = file;
        link.onclick = e => {
          e.preventDefault();
          e.stopPropagation();
          openAdminViewer(filePath);
        };
        item.append(cb, link);
        item.onclick = () => select(item, filePath);
        container.appendChild(item);
      });

  }

  function load(path, container) {
    fetch('/admin/events/ls?path=' + encodeURIComponent(path))
      .then(r => r.json())
      .then(data => render(data, path, container));
  }

  fetch('/admin/events/ls')
    .then(r => r.json())
    .then(data => render(data, '', browser));

  // DELETE FORM
document.getElementById('deleteSelectedForm').onsubmit = e => {
  e.preventDefault();

  const files = getSelectedFiles();
  let folder = null;

  // If no files are selected, check if a folder is selected
  if (!files.length && selectedItem && selectedItem.tagName === 'A') {
    folder = deletePath.value; // the folder path from hidden input
  }

  if (!files.length && !folder) {
    alert('No file or folder selected');
    return;
  }

  modalName.textContent =
    files.length
      ? `${files.length} file(s)`
      : folder;

  modal.show();

  confirmDeleteBtn.onclick = () => {
    modal.hide();

    fetch('/admin/events/delete-selected', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ files, folder })
    })
    .then(res => res.json())
    .then(() => location.reload())
    .catch(err => console.error(err));
  };
};


});
</script>

</body>
